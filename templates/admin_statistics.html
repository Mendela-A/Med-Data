{% extends "base.html" %}

{% block title %}Статистика - Сервіс виписок{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active">Статистика</li>
{% endblock %}

{% block container_class %}container-fluid px-4{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-bar-chart-line me-2"></i>Статистика</h3>
</div>

<!-- Month Filter - Compact -->
<div class="card mb-3">
  <div class="card-body py-2">
    <form method="get" action="{{ url_for('admin.admin_statistics') }}" id="monthFilterForm" class="d-flex align-items-center gap-2 flex-wrap">
      <label for="month_select" class="form-label mb-0 me-2">
        <i class="bi bi-calendar-month me-1"></i><strong>Місяць:</strong>
      </label>
      <input
        type="month"
        class="form-control form-control-sm"
        id="month_select"
        name="month_year"
        value="{{ '%04d-%02d'|format(selected_year, selected_month) }}"
        min="2020-01"
        style="width: auto;">
      <button type="submit" class="btn btn-primary btn-sm">
        <i class="bi bi-search me-1"></i>Показати
      </button>
      <a href="{{ url_for('admin.admin_statistics') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-clockwise me-1"></i>Поточний
      </a>
      <div class="ms-auto">
        <span class="badge bg-primary" style="font-size: 0.95rem; padding: 0.4rem 0.8rem;">
          {{ current_month }}
        </span>
      </div>
    </form>
  </div>
</div>

<!-- KPI Cards with Progress Bars and Trends -->
<div class="row mb-4 g-3">
  <!-- Total -->
  <div class="col-md-3 col-sm-6">
    <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), from_stats='1') }}"
       class="text-decoration-none stat-card-link">
      <div class="card stat-card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="card-subtitle text-muted mb-1" style="font-size: 0.85rem;">
                <i class="bi bi-clipboard-data me-1"></i>Всього записів
              </h6>
              <h3 class="mb-0 text-primary">{{ total_records }}</h3>
            </div>
            <div class="text-end">
              {% if trends.total > 0 %}
                <span class="badge bg-success-subtle text-success">
                  <i class="bi bi-arrow-up"></i>{{ trends.total }}
                </span>
              {% elif trends.total < 0 %}
                <span class="badge bg-danger-subtle text-danger">
                  <i class="bi bi-arrow-down"></i>{{ trends.total|abs }}
                </span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary">
                  <i class="bi bi-dash"></i>0
                </span>
              {% endif %}
            </div>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
          </div>
          <small class="text-muted" style="font-size: 0.75rem;">100% від всього</small>
        </div>
      </div>
    </a>
  </div>

  <!-- Processing -->
  <div class="col-md-3 col-sm-6">
    <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Опрацьовується', from_stats='1') }}"
       class="text-decoration-none stat-card-link">
      <div class="card stat-card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="card-subtitle text-muted mb-1" style="font-size: 0.85rem;">
                <i class="bi bi-hourglass-split me-1"></i>Опрацьовується
              </h6>
              <h3 class="mb-0 text-warning">{{ status_distribution['Опрацьовується'] }}</h3>
            </div>
            <div class="text-end">
              {% if trends.processing > 0 %}
                <span class="badge bg-danger-subtle text-danger">
                  <i class="bi bi-arrow-up"></i>{{ trends.processing }}
                </span>
              {% elif trends.processing < 0 %}
                <span class="badge bg-success-subtle text-success">
                  <i class="bi bi-arrow-down"></i>{{ trends.processing|abs }}
                </span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary">
                  <i class="bi bi-dash"></i>0
                </span>
              {% endif %}
            </div>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-warning" role="progressbar"
                 style="width: {{ (status_distribution['Опрацьовується'] / total_records * 100) if total_records > 0 else 0 }}%"></div>
          </div>
          <small class="text-muted" style="font-size: 0.75rem;">
            {{ "%.1f"|format((status_distribution['Опрацьовується'] / total_records * 100) if total_records > 0 else 0) }}% від всього
          </small>
        </div>
      </div>
    </a>
  </div>

  <!-- Discharged -->
  <div class="col-md-3 col-sm-6">
    <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Виписаний', from_stats='1') }}"
       class="text-decoration-none stat-card-link">
      <div class="card stat-card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="card-subtitle text-muted mb-1" style="font-size: 0.85rem;">
                <i class="bi bi-check-circle me-1"></i>Виписаних
              </h6>
              <h3 class="mb-0 text-success">{{ status_distribution['Виписаний'] }}</h3>
            </div>
            <div class="text-end">
              {% if trends.discharged > 0 %}
                <span class="badge bg-success-subtle text-success">
                  <i class="bi bi-arrow-up"></i>{{ trends.discharged }}
                </span>
              {% elif trends.discharged < 0 %}
                <span class="badge bg-danger-subtle text-danger">
                  <i class="bi bi-arrow-down"></i>{{ trends.discharged|abs }}
                </span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary">
                  <i class="bi bi-dash"></i>0
                </span>
              {% endif %}
            </div>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-success" role="progressbar"
                 style="width: {{ (status_distribution['Виписаний'] / total_records * 100) if total_records > 0 else 0 }}%"></div>
          </div>
          <small class="text-muted" style="font-size: 0.75rem;">
            {{ "%.1f"|format((status_distribution['Виписаний'] / total_records * 100) if total_records > 0 else 0) }}% від всього
          </small>
        </div>
      </div>
    </a>
  </div>

  <!-- Deceased -->
  <div class="col-md-3 col-sm-6">
    <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), has_death_date='1', from_stats='1') }}"
       class="text-decoration-none stat-card-link">
      <div class="card stat-card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="card-subtitle text-muted mb-1" style="font-size: 0.85rem;">
                <i class="bi bi-heartbreak me-1"></i>Померло
              </h6>
              <h3 class="mb-0 text-danger">{{ status_distribution['Помер'] }}</h3>
            </div>
            <div class="text-end">
              {% if trends.deceased > 0 %}
                <span class="badge bg-danger-subtle text-danger">
                  <i class="bi bi-arrow-up"></i>{{ trends.deceased }}
                </span>
              {% elif trends.deceased < 0 %}
                <span class="badge bg-success-subtle text-success">
                  <i class="bi bi-arrow-down"></i>{{ trends.deceased|abs }}
                </span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary">
                  <i class="bi bi-dash"></i>0
                </span>
              {% endif %}
            </div>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-danger" role="progressbar"
                 style="width: {{ (status_distribution['Помер'] / total_records * 100) if total_records > 0 else 0 }}%"></div>
          </div>
          <small class="text-muted" style="font-size: 0.75rem;">
            {{ "%.1f"|format((status_distribution['Помер'] / total_records * 100) if total_records > 0 else 0) }}% від всього
          </small>
        </div>
      </div>
    </a>
  </div>
</div>

<!-- Section 2: Status distribution by department -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-building me-2"></i>Розподіл статусів по відділеннях
      <button type="button"
              class="btn btn-sm btn-outline-secondary ms-2"
              data-bs-toggle="popover"
              data-bs-placement="bottom"
              data-bs-html="true"
              data-bs-title="<i class='bi bi-info-circle me-1'></i>Як рахується статистика?"
              data-bs-content="<ul class='mb-0 ps-3'><li><strong>Померло</strong> — пріоритетна категорія: всі записи з датою смерті рахуються сюди, незалежно від статусу виписки</li><li><strong>Виписаний, Опрацьовується</strong> — рахуються тільки записи БЕЗ дати смерті</li><li><strong>Всього</strong> = сума всіх категорій по відділенню</li></ul>">
        <i class="bi bi-question-circle"></i>
      </button>
    </h5>

    {% if status_by_dept %}
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm" id="statusByDeptTable">
        <thead class="table-light">
          <tr>
            <th class="sortable-header" data-column="department" data-type="text" title="Натисніть для сортування">
              Відділення <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center"
                data-column="processing"
                data-type="number"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Записи зі статусом 'Опрацьовується' без дати смерті. Натисніть для сортування">
              Опрацьовується <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center"
                data-column="discharged"
                data-type="number"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Записи зі статусом 'Виписаний' без дати смерті. Натисніть для сортування">
              Виписаний <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center"
                data-column="deceased"
                data-type="number"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Всі записи з датою смерті (незалежно від статусу виписки). Натисніть для сортування">
              Помер <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center"
                data-column="total"
                data-type="number"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Сума всіх категорій по відділенню. Натисніть для сортування">
              Всього <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
          </tr>
        </thead>
        <tbody id="statusByDeptBody">
          {% for dept in dept_list %}
          <tr>
            <td>
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, from_stats='1') }}"
                 class="text-decoration-none text-dark fw-bold"
                 title="Переглянути всі записи для {{ dept }}">
                {{ dept }}
              </a>
            </td>
            <td>
              {% set dept_total = status_by_dept[dept]['Опрацьовується'] + status_by_dept[dept]['Виписаний'] + status_by_dept[dept]['Помер'] %}
              {% set proc_pct = (status_by_dept[dept]['Опрацьовується'] / dept_total * 100) if dept_total > 0 else 0 %}
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, discharge_status='Опрацьовується', from_stats='1') }}"
                 class="text-decoration-none">
                <div class="d-flex align-items-center">
                  <span class="badge bg-warning me-2">{{ status_by_dept[dept]['Опрацьовується'] }}</span>
                  <div class="progress flex-grow-1" style="height: 8px; min-width: 60px;">
                    <div class="progress-bar bg-warning" style="width: {{ proc_pct }}%"></div>
                  </div>
                </div>
              </a>
            </td>
            <td>
              {% set disch_pct = (status_by_dept[dept]['Виписаний'] / dept_total * 100) if dept_total > 0 else 0 %}
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, discharge_status='Виписаний', from_stats='1') }}"
                 class="text-decoration-none">
                <div class="d-flex align-items-center">
                  <span class="badge bg-success me-2">{{ status_by_dept[dept]['Виписаний'] }}</span>
                  <div class="progress flex-grow-1" style="height: 8px; min-width: 60px;">
                    <div class="progress-bar bg-success" style="width: {{ disch_pct }}%"></div>
                  </div>
                </div>
              </a>
            </td>
            <td>
              {% set dec_pct = (status_by_dept[dept]['Помер'] / dept_total * 100) if dept_total > 0 else 0 %}
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, has_death_date='1', from_stats='1') }}"
                 class="text-decoration-none">
                <div class="d-flex align-items-center">
                  <span class="badge bg-danger me-2">{{ status_by_dept[dept]['Помер'] }}</span>
                  <div class="progress flex-grow-1" style="height: 8px; min-width: 60px;">
                    <div class="progress-bar bg-danger" style="width: {{ dec_pct }}%"></div>
                  </div>
                </div>
              </a>
            </td>
            <td class="text-center">
              <strong>{{ status_by_dept[dept]['Опрацьовується'] + status_by_dept[dept]['Виписаний'] + status_by_dept[dept]['Помер'] }}</strong>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th>
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), from_stats='1') }}"
                 class="text-decoration-none text-dark"
                 title="Переглянути всі записи">
                Всього
              </a>
            </th>
            <th class="text-center">
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Опрацьовується', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути всі записи що опрацьовуються">
                <span class="badge bg-warning badge-clickable">{{ status_distribution['Опрацьовується'] }}</span>
              </a>
            </th>
            <th class="text-center">
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Виписаний', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути всі виписані записи">
                <span class="badge bg-success badge-clickable">{{ status_distribution['Виписаний'] }}</span>
              </a>
            </th>
            <th class="text-center">
              <a href="{{ url_for('records.index', month_filter='%04d-%02d'|format(selected_year, selected_month), has_death_date='1', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути всі записи померлих">
                <span class="badge bg-danger badge-clickable">{{ status_distribution['Помер'] }}</span>
              </a>
            </th>
            <th class="text-center">
              <strong>{{ total_records }}</strong>
            </th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="text-muted">Немає даних за поточний місяць</p>
    {% endif %}
  </div>
</div>

<!-- Section 1: Records by discharge date -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-calendar-check me-2"></i>Записи по датах виписки
    </h5>

    {% if records_per_day %}
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm">
        <thead class="table-light">
          <tr>
            <th>Дата</th>
            <th class="text-end">Кількість записів</th>
          </tr>
        </thead>
        <tbody>
          {% for record in records_per_day %}
          <tr>
            <td>{{ record.date }}</td>
            <td class="text-end"><strong>{{ record.count }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th>Всього</th>
            <th class="text-end"><strong>{{ records_per_day | sum(attribute='count') }}</strong></th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="text-muted">Немає даних за поточний місяць</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Handle month selection form submission
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    // Initialize Bootstrap popovers
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

    const form = document.getElementById('monthFilterForm');
    const monthInput = document.getElementById('month_select');

    if (form && monthInput) {
      // Submit form when month is selected
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const selectedValue = monthInput.value;
        if (!selectedValue) {
          return;
        }

        const [year, month] = selectedValue.split('-');

        // Build URL with year and month parameters
        const url = new URL(window.location.href);
        url.searchParams.set('year', year);
        url.searchParams.set('month', month);

        // Navigate to the new URL
        window.location.href = url.toString();
      });

      // Optional: Submit on change for faster UX
      monthInput.addEventListener('change', function() {
        if (this.value) {
          form.dispatchEvent(new Event('submit'));
        }
      });
    }

    // Table sorting functionality
    const table = document.getElementById('statusByDeptTable');
    const tbody = document.getElementById('statusByDeptBody');

    if (table && tbody) {
      let currentSort = {
        column: localStorage.getItem('stats_sort_column') || 'department',
        order: localStorage.getItem('stats_sort_order') || 'asc'
      };

      // Function to extract sortable value from cell
      function getCellValue(row, column) {
        const cells = row.cells;
        let value;

        switch(column) {
          case 'department':
            value = cells[0].textContent.trim();
            break;
          case 'processing':
            value = parseInt(cells[1].querySelector('.badge').textContent.trim()) || 0;
            break;
          case 'discharged':
            value = parseInt(cells[2].querySelector('.badge').textContent.trim()) || 0;
            break;
          case 'deceased':
            value = parseInt(cells[3].querySelector('.badge').textContent.trim()) || 0;
            break;
          case 'total':
            value = parseInt(cells[4].textContent.trim()) || 0;
            break;
          default:
            value = cells[0].textContent.trim();
        }

        return value;
      }

      // Function to sort table
      function sortTable(column, order) {
        // Add sorting class for animation
        tbody.classList.add('sorting');

        // Get all rows except footer
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Sort rows
        rows.sort((a, b) => {
          const aValue = getCellValue(a, column);
          const bValue = getCellValue(b, column);

          let comparison = 0;

          if (typeof aValue === 'string') {
            comparison = aValue.localeCompare(bValue, 'uk');
          } else {
            comparison = aValue - bValue;
          }

          return order === 'asc' ? comparison : -comparison;
        });

        // Remove sorting animation after a delay
        setTimeout(() => {
          // Reorder DOM
          rows.forEach(row => tbody.appendChild(row));
          tbody.classList.remove('sorting');
        }, 150);

        // Update header states
        updateHeaderStates(column, order);

        // Save to localStorage
        localStorage.setItem('stats_sort_column', column);
        localStorage.setItem('stats_sort_order', order);

        currentSort = { column, order };
      }

      // Function to update header visual states
      function updateHeaderStates(column, order) {
        const headers = table.querySelectorAll('.sortable-header');
        headers.forEach(header => {
          header.classList.remove('sorted-asc', 'sorted-desc');
          if (header.dataset.column === column) {
            header.classList.add(order === 'asc' ? 'sorted-asc' : 'sorted-desc');
          }
        });
      }

      // Add click handlers to sortable headers
      const headers = table.querySelectorAll('.sortable-header');
      headers.forEach(header => {
        header.addEventListener('click', function() {
          const column = this.dataset.column;
          let order = 'desc'; // Default to descending for numbers (most useful)

          // If clicking the same column, toggle order
          if (currentSort.column === column) {
            order = currentSort.order === 'asc' ? 'desc' : 'asc';
          } else {
            // For department (text), default to ascending
            if (column === 'department') {
              order = 'asc';
            }
          }

          sortTable(column, order);
        });
      });

      // Apply saved sort on page load
      if (currentSort.column && currentSort.order) {
        sortTable(currentSort.column, currentSort.order);
      }
    }
  });
</script>
{% endblock %}
