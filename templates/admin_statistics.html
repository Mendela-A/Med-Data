{% extends "base.html" %}

{% block title %}Статистика - Сервіс виписок{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active">Статистика</li>
{% endblock %}

{% block container_class %}container-fluid px-4{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-bar-chart-line me-2"></i>Статистика</h3>
</div>

<!-- Month Filter -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" action="{{ url_for('admin_statistics') }}" id="monthFilterForm" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="month_select" class="form-label small fw-bold">
          <i class="bi bi-calendar-month me-1"></i>Виберіть місяць
        </label>
        <input
          type="month"
          class="form-control"
          id="month_select"
          name="month_year"
          value="{{ '%04d-%02d'|format(selected_year, selected_month) }}"
          min="2020-01">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search me-1"></i>Показати
        </button>
      </div>
      <div class="col-md-2">
        <a href="{{ url_for('admin_statistics') }}" class="btn btn-outline-secondary w-100">
          <i class="bi bi-arrow-clockwise me-1"></i>Поточний
        </a>
      </div>
      <div class="col-md-5 text-end">
        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
          {{ current_month }}
        </span>
      </div>
    </form>
  </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), from_stats='1') }}"
       class="text-decoration-none stat-card-link"
       data-bs-toggle="tooltip"
       data-bs-placement="top"
       data-bs-title="Загальна кількість записів за обраний місяць">
      <div class="card stat-card">
        <div class="card-body text-center">
          <h5 class="card-title text-muted small">Всього записів</h5>
          <h2 class="text-primary mb-0">{{ total_records }}</h2>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-3">
    <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Опрацьовується', from_stats='1') }}"
       class="text-decoration-none stat-card-link"
       data-bs-toggle="tooltip"
       data-bs-placement="top"
       data-bs-title="Записи зі статусом 'Опрацьовується' без дати смерті">
      <div class="card stat-card">
        <div class="card-body text-center">
          <h5 class="card-title text-muted small">Опрацьовується</h5>
          <h2 class="text-secondary mb-0">{{ status_distribution['Опрацьовується'] }}</h2>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-3">
    <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Виписаний', from_stats='1') }}"
       class="text-decoration-none stat-card-link"
       data-bs-toggle="tooltip"
       data-bs-placement="top"
       data-bs-title="Записи зі статусом 'Виписаний' без дати смерті">
      <div class="card stat-card">
        <div class="card-body text-center">
          <h5 class="card-title text-muted small">Виписаних</h5>
          <h2 class="text-success mb-0">{{ status_distribution['Виписаний'] }}</h2>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-3">
    <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), has_death_date='1', from_stats='1') }}"
       class="text-decoration-none stat-card-link"
       data-bs-toggle="tooltip"
       data-bs-placement="top"
       data-bs-title="Всі записи з датою смерті (незалежно від статусу виписки)">
      <div class="card stat-card">
        <div class="card-body text-center">
          <h5 class="card-title text-muted small">Померло</h5>
          <h2 class="text-danger mb-0">{{ status_distribution['Помер'] }}</h2>
        </div>
      </div>
    </a>
  </div>
</div>

<!-- Section 2: Status distribution by department -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-building me-2"></i>Розподіл статусів по відділеннях
    </h5>

    {% if status_by_dept %}
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm" id="statusByDeptTable">
        <thead class="table-light">
          <tr>
            <th class="sortable-header" data-column="department" data-type="text" title="Натисніть для сортування">
              Відділення <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center" data-column="processing" data-type="number" title="Натисніть для сортування">
              Опрацьовується <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center" data-column="discharged" data-type="number" title="Натисніть для сортування">
              Виписаний <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center" data-column="deceased" data-type="number" title="Натисніть для сортування">
              Помер <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
            <th class="sortable-header text-center" data-column="total" data-type="number" title="Натисніть для сортування">
              Всього <i class="bi bi-chevron-expand sort-icon"></i>
            </th>
          </tr>
        </thead>
        <tbody id="statusByDeptBody">
          {% for dept in dept_list %}
          <tr>
            <td>
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, from_stats='1') }}"
                 class="text-decoration-none text-dark fw-bold"
                 title="Переглянути всі записи для {{ dept }}">
                {{ dept }}
              </a>
            </td>
            <td class="text-center">
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, discharge_status='Опрацьовується', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути записи що опрацьовуються для {{ dept }}">
                <span class="badge bg-secondary badge-clickable">{{ status_by_dept[dept]['Опрацьовується'] }}</span>
              </a>
            </td>
            <td class="text-center">
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, discharge_status='Виписаний', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути виписані записи для {{ dept }}">
                <span class="badge bg-success badge-clickable">{{ status_by_dept[dept]['Виписаний'] }}</span>
              </a>
            </td>
            <td class="text-center">
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_department=dept, has_death_date='1', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути записи померлих для {{ dept }}">
                <span class="badge bg-danger badge-clickable">{{ status_by_dept[dept]['Помер'] }}</span>
              </a>
            </td>
            <td class="text-center">
              <strong>{{ status_by_dept[dept]['Опрацьовується'] + status_by_dept[dept]['Виписаний'] + status_by_dept[dept]['Помер'] }}</strong>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th>
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), from_stats='1') }}"
                 class="text-decoration-none text-dark"
                 title="Переглянути всі записи">
                Всього
              </a>
            </th>
            <th class="text-center">
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Опрацьовується', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути всі записи що опрацьовуються">
                <span class="badge bg-secondary badge-clickable">{{ status_distribution['Опрацьовується'] }}</span>
              </a>
            </th>
            <th class="text-center">
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), discharge_status='Виписаний', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути всі виписані записи">
                <span class="badge bg-success badge-clickable">{{ status_distribution['Виписаний'] }}</span>
              </a>
            </th>
            <th class="text-center">
              <a href="{{ url_for('index', month_filter='%04d-%02d'|format(selected_year, selected_month), has_death_date='1', from_stats='1') }}"
                 class="text-decoration-none"
                 title="Переглянути всі записи померлих">
                <span class="badge bg-danger badge-clickable">{{ status_distribution['Помер'] }}</span>
              </a>
            </th>
            <th class="text-center">
              <strong>{{ total_records }}</strong>
            </th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="text-muted">Немає даних за поточний місяць</p>
    {% endif %}
  </div>
</div>

<!-- Section 3: Overall status distribution (pie chart data in table format) -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-pie-chart me-2"></i>Загальний розподіл статусів
    </h5>

    <div class="row">
      <div class="col-md-6">
        <table class="table table-striped table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Статус</th>
              <th class="text-end">Кількість</th>
              <th class="text-end">%</th>
            </tr>
          </thead>
          <tbody>
            {% for status, count in status_distribution.items() %}
            <tr>
              <td>
                {% if status == 'Опрацьовується' %}
                <span class="badge bg-secondary">{{ status }}</span>
                {% elif status == 'Виписаний' %}
                <span class="badge bg-success">{{ status }}</span>
                {% elif status == 'Помер' %}
                <span class="badge bg-danger">{{ status }}</span>
                {% endif %}
              </td>
              <td class="text-end"><strong>{{ count }}</strong></td>
              <td class="text-end">
                {% if total_records > 0 %}
                {{ "%.1f"|format((count / total_records * 100)) }}%
                {% else %}
                0.0%
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th>Всього</th>
              <th class="text-end"><strong>{{ total_records }}</strong></th>
              <th class="text-end">100%</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Section 1: Records added per day -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-calendar-plus me-2"></i>Записи додані за день
    </h5>

    {% if records_per_day %}
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm">
        <thead class="table-light">
          <tr>
            <th>Дата</th>
            <th class="text-end">Кількість записів</th>
          </tr>
        </thead>
        <tbody>
          {% for record in records_per_day %}
          <tr>
            <td>{{ record.date }}</td>
            <td class="text-end"><strong>{{ record.count }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th>Всього</th>
            <th class="text-end"><strong>{{ records_per_day | sum(attribute='count') }}</strong></th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="text-muted">Немає даних за поточний місяць</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Handle month selection form submission
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    const form = document.getElementById('monthFilterForm');
    const monthInput = document.getElementById('month_select');

    if (form && monthInput) {
      // Submit form when month is selected
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const selectedValue = monthInput.value;
        if (!selectedValue) {
          return;
        }

        const [year, month] = selectedValue.split('-');

        // Build URL with year and month parameters
        const url = new URL(window.location.href);
        url.searchParams.set('year', year);
        url.searchParams.set('month', month);

        // Navigate to the new URL
        window.location.href = url.toString();
      });

      // Optional: Submit on change for faster UX
      monthInput.addEventListener('change', function() {
        if (this.value) {
          form.dispatchEvent(new Event('submit'));
        }
      });
    }

    // Table sorting functionality
    const table = document.getElementById('statusByDeptTable');
    const tbody = document.getElementById('statusByDeptBody');

    if (table && tbody) {
      let currentSort = {
        column: localStorage.getItem('stats_sort_column') || 'department',
        order: localStorage.getItem('stats_sort_order') || 'asc'
      };

      // Function to extract sortable value from cell
      function getCellValue(row, column) {
        const cells = row.cells;
        let value;

        switch(column) {
          case 'department':
            value = cells[0].textContent.trim();
            break;
          case 'processing':
            value = parseInt(cells[1].querySelector('.badge').textContent.trim()) || 0;
            break;
          case 'discharged':
            value = parseInt(cells[2].querySelector('.badge').textContent.trim()) || 0;
            break;
          case 'deceased':
            value = parseInt(cells[3].querySelector('.badge').textContent.trim()) || 0;
            break;
          case 'total':
            value = parseInt(cells[4].textContent.trim()) || 0;
            break;
          default:
            value = cells[0].textContent.trim();
        }

        return value;
      }

      // Function to sort table
      function sortTable(column, order) {
        // Add sorting class for animation
        tbody.classList.add('sorting');

        // Get all rows except footer
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Sort rows
        rows.sort((a, b) => {
          const aValue = getCellValue(a, column);
          const bValue = getCellValue(b, column);

          let comparison = 0;

          if (typeof aValue === 'string') {
            comparison = aValue.localeCompare(bValue, 'uk');
          } else {
            comparison = aValue - bValue;
          }

          return order === 'asc' ? comparison : -comparison;
        });

        // Remove sorting animation after a delay
        setTimeout(() => {
          // Reorder DOM
          rows.forEach(row => tbody.appendChild(row));
          tbody.classList.remove('sorting');
        }, 150);

        // Update header states
        updateHeaderStates(column, order);

        // Save to localStorage
        localStorage.setItem('stats_sort_column', column);
        localStorage.setItem('stats_sort_order', order);

        currentSort = { column, order };
      }

      // Function to update header visual states
      function updateHeaderStates(column, order) {
        const headers = table.querySelectorAll('.sortable-header');
        headers.forEach(header => {
          header.classList.remove('sorted-asc', 'sorted-desc');
          if (header.dataset.column === column) {
            header.classList.add(order === 'asc' ? 'sorted-asc' : 'sorted-desc');
          }
        });
      }

      // Add click handlers to sortable headers
      const headers = table.querySelectorAll('.sortable-header');
      headers.forEach(header => {
        header.addEventListener('click', function() {
          const column = this.dataset.column;
          let order = 'desc'; // Default to descending for numbers (most useful)

          // If clicking the same column, toggle order
          if (currentSort.column === column) {
            order = currentSort.order === 'asc' ? 'desc' : 'asc';
          } else {
            // For department (text), default to ascending
            if (column === 'department') {
              order = 'asc';
            }
          }

          sortTable(column, order);
        });
      });

      // Apply saved sort on page load
      if (currentSort.column && currentSort.order) {
        sortTable(currentSort.column, currentSort.order);
      }
    }
  });
</script>
{% endblock %}
