{% extends "base.html" %}

{% block title %}Статистика - Сервіс виписок{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active">Статистика</li>
{% endblock %}

{% block container_class %}container-fluid px-4{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-bar-chart-line me-2"></i>Статистика</h3>
</div>

<!-- Month Filter -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" action="{{ url_for('admin_statistics') }}" id="monthFilterForm" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="month_select" class="form-label small fw-bold">
          <i class="bi bi-calendar-month me-1"></i>Виберіть місяць
        </label>
        <input
          type="month"
          class="form-control"
          id="month_select"
          name="month_year"
          value="{{ '%04d-%02d'|format(selected_year, selected_month) }}"
          min="2020-01">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search me-1"></i>Показати
        </button>
      </div>
      <div class="col-md-2">
        <a href="{{ url_for('admin_statistics') }}" class="btn btn-outline-secondary w-100">
          <i class="bi bi-arrow-clockwise me-1"></i>Поточний
        </a>
      </div>
      <div class="col-md-5 text-end">
        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
          {{ current_month }}
        </span>
      </div>
    </form>
  </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title text-muted small">Всього записів</h5>
        <h2 class="text-primary mb-0">{{ total_records }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title text-muted small">Опрацьовується</h5>
        <h2 class="text-secondary mb-0">{{ status_distribution['Опрацьовується'] }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title text-muted small">Виписаних</h5>
        <h2 class="text-success mb-0">{{ status_distribution['Виписаний'] }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title text-muted small">Померло</h5>
        <h2 class="text-danger mb-0">{{ status_distribution['Помер'] }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- Section 1: Records added per day -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-calendar-plus me-2"></i>Записи додані за день
    </h5>

    {% if records_per_day %}
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm">
        <thead class="table-light">
          <tr>
            <th>Дата</th>
            <th class="text-end">Кількість записів</th>
          </tr>
        </thead>
        <tbody>
          {% for record in records_per_day %}
          <tr>
            <td>{{ record.date }}</td>
            <td class="text-end"><strong>{{ record.count }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th>Всього</th>
            <th class="text-end"><strong>{{ records_per_day | sum(attribute='count') }}</strong></th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="text-muted">Немає даних за поточний місяць</p>
    {% endif %}
  </div>
</div>

<!-- Section 2: Status distribution by department -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-building me-2"></i>Розподіл статусів по відділеннях
    </h5>

    {% if status_by_dept %}
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm">
        <thead class="table-light">
          <tr>
            <th>Відділення</th>
            <th class="text-center">Опрацьовується</th>
            <th class="text-center">Виписаний</th>
            <th class="text-center">Помер</th>
            <th class="text-center">Всього</th>
          </tr>
        </thead>
        <tbody>
          {% for dept in dept_list %}
          <tr>
            <td><strong>{{ dept }}</strong></td>
            <td class="text-center">
              <span class="badge bg-secondary">{{ status_by_dept[dept]['Опрацьовується'] }}</span>
            </td>
            <td class="text-center">
              <span class="badge bg-success">{{ status_by_dept[dept]['Виписаний'] }}</span>
            </td>
            <td class="text-center">
              <span class="badge bg-danger">{{ status_by_dept[dept]['Помер'] }}</span>
            </td>
            <td class="text-center">
              <strong>{{ status_by_dept[dept]['Опрацьовується'] + status_by_dept[dept]['Виписаний'] + status_by_dept[dept]['Помер'] }}</strong>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th>Всього</th>
            <th class="text-center">
              <span class="badge bg-secondary">{{ status_distribution['Опрацьовується'] }}</span>
            </th>
            <th class="text-center">
              <span class="badge bg-success">{{ status_distribution['Виписаний'] }}</span>
            </th>
            <th class="text-center">
              <span class="badge bg-danger">{{ status_distribution['Помер'] }}</span>
            </th>
            <th class="text-center">
              <strong>{{ total_records }}</strong>
            </th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="text-muted">Немає даних за поточний місяць</p>
    {% endif %}
  </div>
</div>

<!-- Section 3: Overall status distribution (pie chart data in table format) -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-pie-chart me-2"></i>Загальний розподіл статусів
    </h5>

    <div class="row">
      <div class="col-md-6">
        <table class="table table-striped table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Статус</th>
              <th class="text-end">Кількість</th>
              <th class="text-end">%</th>
            </tr>
          </thead>
          <tbody>
            {% for status, count in status_distribution.items() %}
            <tr>
              <td>
                {% if status == 'Опрацьовується' %}
                <span class="badge bg-secondary">{{ status }}</span>
                {% elif status == 'Виписаний' %}
                <span class="badge bg-success">{{ status }}</span>
                {% elif status == 'Помер' %}
                <span class="badge bg-danger">{{ status }}</span>
                {% endif %}
              </td>
              <td class="text-end"><strong>{{ count }}</strong></td>
              <td class="text-end">
                {% if total_records > 0 %}
                {{ "%.1f"|format((count / total_records * 100)) }}%
                {% else %}
                0.0%
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th>Всього</th>
              <th class="text-end"><strong>{{ total_records }}</strong></th>
              <th class="text-end">100%</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="col-md-6">
        <div class="alert alert-info">
          <h6><i class="bi bi-info-circle me-2"></i>Додаткова інформація</h6>
          <ul class="mb-0 small">
            <li>Дані відображаються за обраний період: <strong>{{ current_month }}</strong></li>
            <li>Статистика оновлюється в реальному часі</li>
            <li>Доступна історія з 2020 року</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Handle month selection form submission
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('monthFilterForm');
    const monthInput = document.getElementById('month_select');

    if (form && monthInput) {
      // Submit form when month is selected
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const selectedValue = monthInput.value;
        if (!selectedValue) {
          return;
        }

        const [year, month] = selectedValue.split('-');

        // Build URL with year and month parameters
        const url = new URL(window.location.href);
        url.searchParams.set('year', year);
        url.searchParams.set('month', month);

        // Navigate to the new URL
        window.location.href = url.toString();
      });

      // Optional: Submit on change for faster UX
      monthInput.addEventListener('change', function() {
        if (this.value) {
          form.dispatchEvent(new Event('submit'));
        }
      });
    }
  });
</script>
{% endblock %}
