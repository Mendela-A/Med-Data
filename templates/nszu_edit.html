{% extends "base.html" %}
{% block title %}Редагувати перевірку НСЗУ #{{ correction.id }}{% endblock %}
{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{{ url_for('nszu.nszu_list', month_year=filter_month_year, status=filter_status, doctor=filter_doctor, nszu_record_id=filter_nszu_record_id, per_page=filter_per_page, sort_by=filter_sort_by, sort_order=filter_sort_order) }}">Перевірка НСЗУ</a></li>
  <li class="breadcrumb-item active" aria-current="page">Редагувати #{{ correction.id }}</li>
{% endblock %}

{% block content %}
  <h1 class="h4 mb-4"><i class="bi bi-pencil me-2"></i>Редагувати перевірку НСЗУ #{{ correction.id }}</h1>

  <div class="card">
    <div class="card-body">
      <form method="post" class="row g-3">
        <!-- preserve filters so we can return to the filtered list -->
        <input type="hidden" name="filter_month_year" value="{{ filter_month_year }}">
        <input type="hidden" name="filter_status" value="{{ filter_status }}">
        <input type="hidden" name="filter_doctor" value="{{ filter_doctor }}">
        <input type="hidden" name="filter_nszu_record_id" value="{{ filter_nszu_record_id }}">
        <input type="hidden" name="filter_per_page" value="{{ filter_per_page }}">
        <input type="hidden" name="filter_sort_by" value="{{ filter_sort_by }}">
        <input type="hidden" name="filter_sort_order" value="{{ filter_sort_order }}">

        <div class="col-md-6">
          <label class="form-label">Дата <span class="text-danger">*</span></label>
          <input class="form-control" name="date" type="date" value="{{ correction.date.strftime('%Y-%m-%d') if correction.date else '' }}" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">НСЗУ ID <span class="text-danger">*</span></label>
          <input class="form-control" name="nszu_record_id" maxlength="100" value="{{ correction.nszu_record_id }}" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Лікар <span class="text-danger">*</span> {% if doctors %}({{ doctors|length }} у списку){% endif %}</label>
          <input class="form-control" name="doctor" list="doctors-list" autocomplete="off" maxlength="200" value="{{ correction.doctor }}" required>
          <datalist id="doctors-list">
            {% for d in doctors %}
              <option value="{{ d }}">
            {% endfor %}
          </datalist>
        </div>

        <div class="col-md-6">
          <label class="form-label">Статус <span class="text-danger">*</span></label>
          <select class="form-select" name="status" required>
            {% for s in statuses %}
              <option value="{{ s }}" {% if s == correction.status %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Деталі</label>
          <textarea class="form-control" name="detail" rows="3">{{ correction.detail if correction.detail else '' }}</textarea>
        </div>

        <div class="col-md-6">
          <label class="form-label">Фактична сума</label>
          <input class="form-control" name="fakt_summ" type="text" value="{{ '{:.2f}'.format(correction.fakt_summ) if correction.fakt_summ else '0.00' }}">
          <small class="form-text text-muted">Можна вводити з комою або крапкою</small>
        </div>

        <div class="col-12">
          <label class="form-label">Коментар</label>
          <textarea class="form-control" name="comment" rows="2">{{ correction.comment if correction.comment else '' }}</textarea>
        </div>

        <div class="col-12">
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit"><i class="bi bi-check-lg me-1"></i>Зберегти</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('nszu.nszu_list', month_year=filter_month_year, status=filter_status, doctor=filter_doctor, nszu_record_id=filter_nszu_record_id, per_page=filter_per_page, sort_by=filter_sort_by, sort_order=filter_sort_order) }}">Скасувати</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if current_user.role in ['editor', 'admin'] %}
    <div class="card mt-3">
      <div class="card-body py-3">
        <h6 class="text-muted mb-2"><i class="bi bi-info-circle me-1"></i>Інформація про запис</h6>
        <div class="row text-muted small">
          <div class="col-auto">
            <strong>Створив:</strong> {{ correction.creator.username if correction.creator else 'N/A' }}
          </div>
          <div class="col-auto">
            <strong>Створено:</strong> {{ correction.created_at.strftime('%d.%m.%Y %H:%M') if correction.created_at else 'N/A' }}
          </div>
          {% if correction.updater %}
            <div class="col-auto">
              <strong>Оновив:</strong> {{ correction.updater.username }}
            </div>
            <div class="col-auto">
              <strong>Оновлено:</strong> {{ correction.updated_at.strftime('%d.%m.%Y %H:%M') if correction.updated_at else 'N/A' }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
