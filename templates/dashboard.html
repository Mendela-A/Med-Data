{% extends "base.html" %}
{% block title %}Мої записи — поточний місяць{% endblock %}
{% block content %}
  {% block breadcrumbs %}
    <li class="breadcrumb-item active" aria-current="page">Записи</li>
  {% endblock %}

  <h1 class="h3">{% if request.args.get('all_months') %}Мої записи (усі){% else %}Мої записи (цей місяць){% endif %} <span class="badge bg-primary ms-2">{{ count }}</span></h1>

  {% if current_user.role == 'operator' %}
    <div class="alert alert-info">Оператори бачать тільки записи, які вони створили. Для перегляду всіх місяців поставте прапорець "Показати всі місяці".</div>
  {% endif %}

  <form class="filter-form row gx-3 gy-2 align-items-end" method="get">
    <div class="col-sm-6 col-md-3">
      <label class="form-label">Статус виписки</label>
      <select class="form-select" name="discharge_status">
        <option value="">Всі</option>
        {% for s in statuses %}
          <option value="{{ s }}" {% if s == selected_status %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-sm-6 col-md-3">
      <label class="form-label">Лікуючий лікар</label>
      <select class="form-select" name="treating_physician">
        <option value="">Всі</option>
        {% for p in physicians %}
          <option value="{{ p }}" {% if p == selected_physician %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-sm-6 col-md-4">
      <label class="form-label">Пошук по "Історія" (номер)</label>
      <input class="form-control" name="history" placeholder="номер або частина" value="{{ history_q }}">
    </div>

    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="1" id="all_months" name="all_months" {% if request.args.get('all_months') %}checked{% endif %}>
        <label class="form-check-label" for="all_months">Показати всі місяці</label>
      </div>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">Фільтрувати</button>
      <a class="btn btn-secondary ms-2" href="{{ url_for('index') }}">Скинути</a>
    </div>
  </form>

  {% if current_user.role in ['editor', 'admin'] %}
    <form class="export-form row gx-3 gy-2 align-items-end" method="post" action="{{ url_for('export') }}">
      <input type="hidden" name="discharge_status" value="{{ selected_status }}">
      <input type="hidden" name="treating_physician" value="{{ selected_physician }}">
      <input type="hidden" name="history" value="{{ history_q }}">
      <div class="col-auto">
        <label class="form-label">Експорт — від</label>
        <input class="form-control" name="from_date" type="date" required>
      </div>
      <div class="col-auto">
        <label class="form-label">до</label>
        <input class="form-control" name="to_date" type="date" required>
      </div>
      <div class="col-auto">
        <button class="btn btn-success" type="submit">Вигрузити Excel</button>
      </div>
    </form>
  {% endif %}

  {% if records %}
    <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Дата виписки</th>
          <th>ПІБ</th>
          <th>Відділення</th>
          <th>Лікар</th>
          <th>К днів</th>
          <th>Статус виписки</th>
          <th>Дата смерті</th>
          <th>Коментар</th>
          <th>Створив</th>
          <th>Створено</th>
          <th>Дія</th>
        </tr>
      </thead>
      <tbody>
        {% for r in records %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.date_of_discharge.strftime('%d.%m.%Y') if r.date_of_discharge else '' }}</td>
            <td>{{ r.full_name }}</td>
            <td>{{ r.discharge_department or '' }}</td>
            <td>{{ r.treating_physician or '' }}</td>
            <td>{{ r.k_days or '' }}</td>
            <td>{{ r.discharge_status or '' }}</td>
            <td>{{ r.date_of_death.strftime('%d.%m.%Y') if r.date_of_death else '' }}</td>
            <td>{{ r.comment or '' }}</td>
            <td>{{ r.creator.username if r.creator else r.created_by }}</td>
            <td>{{ r.created_at.strftime('%d.%m.%Y %H:%M') if r.created_at else '' }}</td>
            <td>
              {% if current_user.role in ['editor', 'admin'] %}
                <a class="btn-edit" href="{{ url_for('edit_record', record_id=r.id, discharge_status=selected_status, treating_physician=selected_physician, history=history_q) }}">Редагувати</a>
              {% endif %}
              {% if current_user.role == 'admin' %}
                <form method="post" action="{{ url_for('delete_record', record_id=r.id) }}" style="display:inline; margin-left:8px;" onsubmit="return confirm('Ви справді хочете видалити запис #{{ r.id }}?');">
                  <input type="hidden" name="discharge_status" value="{{ selected_status }}">
                  <input type="hidden" name="treating_physician" value="{{ selected_physician }}">
                  <input type="hidden" name="history" value="{{ history_q }}">
                  <button class="btn-delete" type="submit">Видалити</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  {% else %}
    <p>Записів за цей місяць немає.</p>
  {% endif %}
{% endblock %}
