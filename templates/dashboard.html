{% extends "base.html" %}
{% block title %}Мої записи — поточний місяць{% endblock %}
{% block content %}
  <h1>Мої записи (цей місяць)</h1>

  <form class="filter-form" method="get">
    <div class="form-row">
      <label>Статус виписки</label>
      <select name="discharge_status">
        <option value="">Всі</option>
        {% for s in statuses %}
          <option value="{{ s }}" {% if s == selected_status %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-row">
      <label>Лікуючий лікар</label>
      <select name="treating_physician">
        <option value="">Всі</option>
        {% for p in physicians %}
          <option value="{{ p }}" {% if p == selected_physician %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-row">
      <label>Пошук по "Історія" (номер)</label>
      <input name="history" placeholder="номер або частина" value="{{ history_q }}">
    </div>

    <div class="form-actions">
      <button type="submit">Фільтрувати</button>
      <a class="btn-reset" href="{{ url_for('index') }}">Скинути</a>
    </div>
  </form>

  {% if records %}
    <table class="records-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Дата виписки</th>
          <th>ПІБ</th>
          <th>Відділення</th>
          <th>Лікар</th>
          <th>К днів</th>
          <th>Статус виписки</th>
          <th>Статус</th>
          <th>Дата смерті</th>
          <th>Коментар</th>
          <th>Створив</th>
          <th>Створено</th>
          <th>Дія</th>
        </tr>
      </thead>
      <tbody>
        {% for r in records %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.date_of_discharge.strftime('%d.%m.%Y') if r.date_of_discharge else '' }}</td>
            <td>{{ r.full_name }}</td>
            <td>{{ r.discharge_department or '' }}</td>
            <td>{{ r.treating_physician or '' }}</td>
            <td>{{ r.k_days or '' }}</td>
            <td>{{ r.discharge_status or '' }}</td>
            <td>{{ r.status or '' }}</td>
            <td>{{ r.date_of_death.strftime('%d.%m.%Y') if r.date_of_death else '' }}</td>
            <td>{{ r.comment or '' }}</td>
            <td>{{ r.creator.username if r.creator else r.created_by }}</td>
            <td>{{ r.created_at.strftime('%d.%m.%Y %H:%M') if r.created_at else '' }}</td>
            <td>
              {% if current_user.role in ['editor', 'admin'] %}
                <a class="btn-edit" href="{{ url_for('edit_record', record_id=r.id) }}">Редагувати</a>
              {% endif %}
              {% if current_user.role == 'admin' %}
                <form method="post" action="{{ url_for('delete_record', record_id=r.id) }}" style="display:inline; margin-left:8px;" onsubmit="return confirm('Ви справді хочете видалити запис #{{ r.id }}?');">
                  <button class="btn-delete" type="submit">Видалити</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Записів за цей місяць немає.</p>
  {% endif %}
{% endblock %}
