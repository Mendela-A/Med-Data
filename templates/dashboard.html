{% extends "base.html" %}
{% block title %}Мої записи — поточний місяць{% endblock %}
{% block content %}
  {% block breadcrumbs %}
    <li class="breadcrumb-item active" aria-current="page">Записи</li>
  {% endblock %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">
      {% if show_all %}
        Записи (усі періоди)
      {% elif selected_year and selected_month %}
        Записи ({{ ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'][selected_month - 1] }} {{ selected_year }})
      {% else %}
        Записи (поточний місяць)
      {% endif %}
      <span class="badge bg-primary ms-2">{{ count }}</span>
    </h1>
  </div>


  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Фільтри</h5>
      <form class="row g-3" method="get">
        <div class="col-md-3">
          <label class="form-label">Місяць та рік</label>
          <input class="form-control" type="month" name="month_filter" value="{{ month_filter_value }}" id="month_filter">
        </div>

        <div class="col-md-3">
          <label class="form-label">Статус виписки</label>
          <select class="form-select" name="discharge_status">
            <option value="">Всі</option>
            {% for s in statuses %}
              <option value="{{ s }}" {% if s == selected_status %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Лікуючий лікар</label>
          <select class="form-select" name="treating_physician">
            <option value="">Всі</option>
            {% for p in physicians %}
              <option value="{{ p }}" {% if p == selected_physician %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Пошук по історії (номер)</label>
          <input class="form-control" name="history" placeholder="Введіть номер" value="{{ history_q }}">
        </div>

        <div class="col-12">
          <div class="row">
            <div class="col-auto">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="all_months" name="all_months" {% if show_all %}checked{% endif %}>
                <label class="form-check-label" for="all_months">Показати всі місяці</label>
              </div>
            </div>
            <div class="col-auto">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="has_death_date" name="has_death_date" {% if has_death_date %}checked{% endif %}>
                <label class="form-check-label" for="has_death_date">Тільки з датою смерті</label>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <button class="btn btn-primary" type="submit">Застосувати фільтри</button>
          <a class="btn btn-outline-secondary ms-2" href="{{ url_for('index') }}">Скинути</a>
        </div>
      </form>
    </div>
  </div>

  {% if current_user.role in ['editor', 'admin'] %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title mb-3">Експорт в Excel</h5>
        <form class="row g-3 align-items-end" method="post" action="{{ url_for('export') }}">
          <input type="hidden" name="discharge_status" value="{{ selected_status }}">
          <input type="hidden" name="treating_physician" value="{{ selected_physician }}">
          <input type="hidden" name="history" value="{{ history_q }}">
          <div class="col-md-3">
            <label class="form-label">Дата від</label>
            <input class="form-control" name="from_date" type="date" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Дата до</label>
            <input class="form-control" name="to_date" type="date" required>
          </div>
          <div class="col-md-6">
            <button class="btn btn-success" type="submit">
              <i class="bi bi-download"></i> Вигрузити в Excel
            </button>
            <small class="text-muted ms-2">Експорт записів з застосованими фільтрами</small>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  {% if records %}
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Дата виписки</th>
                <th>ПІБ</th>
                <th>Відділення</th>
                <th>Лікар</th>
                <th>Історія</th>
                <th>К днів</th>
                <th>Статус виписки</th>
                <th>Дата смерті</th>
                <th>Коментар</th>
                <th>Створив</th>
                <th>Створено</th>
                <th>Дія</th>
              </tr>
            </thead>
      <tbody>
        {% for r in records %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.date_of_discharge.strftime('%d.%m.%Y') if r.date_of_discharge else '' }}</td>
            <td>{{ r.full_name }}</td>
            <td>{{ r.discharge_department or '' }}</td>
            <td>{{ r.treating_physician or '' }}</td>
            <td>{{ r.history or '' }}</td>
            <td>{{ r.k_days or '' }}</td>
            <td>
              {% if r.discharge_status == 'Виписаний' %}
                <span class="badge bg-success">{{ r.discharge_status }}</span>
              {% elif r.discharge_status == 'Помер' %}
                <span class="badge bg-danger">{{ r.discharge_status }}</span>
              {% elif r.discharge_status %}
                <span class="badge bg-secondary">{{ r.discharge_status }}</span>
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ r.date_of_death.strftime('%d.%m.%Y') if r.date_of_death else '' }}</td>
            <td>{{ r.comment or '' }}</td>
            <td>{{ r.creator.username if r.creator else r.created_by }}</td>
            <td>{{ r.created_at.strftime('%d.%m.%Y %H:%M') if r.created_at else '' }}</td>
            <td>
              {% if current_user.role in ['editor', 'admin'] %}
                <a class="btn-edit" href="{{ url_for('edit_record', record_id=r.id, discharge_status=selected_status, treating_physician=selected_physician, history=history_q, has_death_date='1' if has_death_date else '') }}">Редагувати</a>
              {% endif %}
              {% if current_user.role == 'admin' %}
                <form method="post" action="{{ url_for('delete_record', record_id=r.id) }}" style="display:inline; margin-left:8px;" onsubmit="return confirm('Ви справді хочете видалити запис #{{ r.id }}?');">
                  <input type="hidden" name="discharge_status" value="{{ selected_status }}">
                  <input type="hidden" name="treating_physician" value="{{ selected_physician }}">
                  <input type="hidden" name="history" value="{{ history_q }}">
                  <input type="hidden" name="has_death_date" value="{{ '1' if has_death_date else '' }}">
                  <button class="btn-delete" type="submit">Видалити</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> Записів за обраний період немає.
    </div>
  {% endif %}

  <script>
    // Disable month filter when "all months" checkbox is checked
    document.addEventListener('DOMContentLoaded', function() {
      const allMonthsCheckbox = document.getElementById('all_months');
      const monthFilter = document.getElementById('month_filter');

      if (allMonthsCheckbox && monthFilter) {
        // Initial state
        if (allMonthsCheckbox.checked) {
          monthFilter.disabled = true;
          monthFilter.value = '';
        }

        // On change
        allMonthsCheckbox.addEventListener('change', function() {
          if (this.checked) {
            monthFilter.disabled = true;
            monthFilter.value = '';
          } else {
            monthFilter.disabled = false;
          }
        });
      }
    });
  </script>
{% endblock %}
