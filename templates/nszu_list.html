{% extends "base.html" %}
{% block title %}Перевірка НСЗУ{% endblock %}
{% block container_class %}container-fluid px-4{% endblock %}
{% block content %}
  {% block breadcrumbs %}
    <li class="breadcrumb-item active" aria-current="page">Перевірка НСЗУ</li>
  {% endblock %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h3 mb-2">Перевірка НСЗУ</h1>
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <span class="badge bg-primary">Всього: {{ count }}</span>
      </div>
    </div>
    {% if current_user.role in ['editor', 'admin'] %}
    <div>
      <a href="{{ url_for('nszu_add') }}" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>Додати запис
      </a>
    </div>
    {% endif %}
  </div>

  <div class="card mb-3">
    <div class="card-body py-3">
      <h5 class="card-title mb-3">Фільтри</h5>
      <form method="get">
        <div class="row g-3 mb-3">
          <div class="col-sm-6 col-md-4 col-xl-3">
            <label class="form-label small mb-1">Статус</label>
            <select class="form-select form-select-sm" name="status">
              <option value="">Всі</option>
              <option value="В обробці" {% if selected_status == 'В обробці' %}selected{% endif %}>В обробці</option>
              <option value="Опрацьовано" {% if selected_status == 'Опрацьовано' %}selected{% endif %}>Опрацьовано</option>
              <option value="Не підлягає оплаті" {% if selected_status == 'Не підлягає оплаті' %}selected{% endif %}>Не підлягає оплаті</option>
            </select>
          </div>

          <div class="col-sm-6 col-md-4 col-xl-3">
            <label class="form-label small mb-1">Лікар</label>
            <select class="form-select form-select-sm" name="doctor">
              <option value="">Всі</option>
              {% for d in doctors %}
                <option value="{{ d }}" {% if d == selected_doctor %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-sm-6 col-md-4 col-xl-3">
            <label class="form-label small mb-1">НСЗУ ID</label>
            <input class="form-control form-control-sm" name="nszu_record_id" placeholder="Пошук за ID" value="{{ nszu_record_id_q }}">
          </div>

          <div class="col-sm-6 col-md-4 col-xl-3">
            <label class="form-label small mb-1">На сторінку:</label>
            <select class="form-select form-select-sm" name="per_page">
              <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if pagination.per_page == 200 %}selected{% endif %}>200</option>
            </select>
          </div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-3 pt-2 border-top">
          <div class="ms-auto">
            <button class="btn btn-primary btn-sm" type="submit">Застосувати</button>
            <a class="btn btn-outline-secondary btn-sm ms-2" href="{{ url_for('nszu_list') }}">Скинути</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if corrections %}
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Дата</th>
                <th>НСЗУ ID</th>
                <th>Лікар</th>
                <th>Статус</th>
                <th>Деталі</th>
                <th>Факт. сума</th>
                <th>Коментар</th>
                {% if current_user.role in ['editor', 'admin'] %}
                  <th>Створив</th>
                  <th>Створено</th>
                  <th>Дія</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for c in corrections %}
                <tr>
                  <td>{{ c.id }}</td>
                  <td>{{ c.date.strftime('%d.%m.%Y') if c.date else '' }}</td>
                  <td><small>{{ c.nszu_record_id }}</small></td>
                  <td>{{ c.doctor }}</td>
                  <td>
                    {% if c.status == 'Опрацьовано' %}
                      <span class="badge bg-success">{{ c.status }}</span>
                    {% elif c.status == 'В обробці' %}
                      <span class="badge bg-warning text-dark">{{ c.status }}</span>
                    {% elif c.status == 'Не підлягає оплаті' %}
                      <span class="badge bg-danger">{{ c.status }}</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ c.status }}</span>
                    {% endif %}
                  </td>
                  <td><small>{{ c.detail[:100] if c.detail else '' }}{% if c.detail and c.detail|length > 100 %}...{% endif %}</small></td>
                  <td>{{ '{:.2f}'.format(c.fakt_summ) if c.fakt_summ else '0.00' }}</td>
                  <td><small>{{ c.comment[:50] if c.comment else '' }}{% if c.comment and c.comment|length > 50 %}...{% endif %}</small></td>
                  {% if current_user.role in ['editor', 'admin'] %}
                    <td>{{ c.creator.username if c.creator else '' }}</td>
                    <td>{{ c.created_at.strftime('%d.%m.%Y %H:%M') if c.created_at else '' }}</td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="{{ url_for('nszu_edit', correction_id=c.id) }}" class="btn btn-outline-primary" title="Редагувати">
                          <i class="bi bi-pencil"></i>
                        </a>
                        {% if current_user.role == 'admin' %}
                          <button type="button" class="btn btn-outline-danger" title="Видалити" onclick="if(confirm('Видалити запис #{{ c.id }}?')) document.getElementById('delete-form-{{ c.id }}').submit();">
                            <i class="bi bi-trash"></i>
                          </button>
                        {% endif %}
                      </div>
                      {% if current_user.role == 'admin' %}
                        <form id="delete-form-{{ c.id }}" method="POST" action="{{ url_for('nszu_delete', correction_id=c.id) }}" style="display: none;">
                        </form>
                      {% endif %}
                    </td>
                  {% endif %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
          <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('nszu_list', page=pagination.prev_num, per_page=pagination.per_page, status=selected_status, doctor=selected_doctor, nszu_record_id=nszu_record_id_q) if pagination.has_prev else '#' }}">Попередня</a>
          </li>

          {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
              <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('nszu_list', page=page_num, per_page=pagination.per_page, status=selected_status, doctor=selected_doctor, nszu_record_id=nszu_record_id_q) }}">{{ page_num }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}

          <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('nszu_list', page=pagination.next_num, per_page=pagination.per_page, status=selected_status, doctor=selected_doctor, nszu_record_id=nszu_record_id_q) if pagination.has_next else '#' }}">Наступна</a>
          </li>
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>Записів не знайдено.
      {% if current_user.role in ['editor', 'admin'] %}
        <a href="{{ url_for('nszu_add') }}">Додати перший запис</a>
      {% endif %}
    </div>
  {% endif %}

{% endblock %}
