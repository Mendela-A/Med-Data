{% extends "base.html" %}
{% block title %}Додати запис{% endblock %}
{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{{ url_for('records.index') }}">Записи</a></li>
  <li class="breadcrumb-item active" aria-current="page">Додати</li>
{% endblock %}

{% block content %}
  <h1 class="h4">Додати запис</h1>
  <form method="post" class="mt-3 row g-2 form-compact">
    <!-- preserve filters so we can return to the filtered list -->
    <input type="hidden" name="filter_discharge_status" value="{{ selected_status }}">
    <input type="hidden" name="filter_treating_physician" value="{{ selected_physician }}">
    <input type="hidden" name="filter_history" value="{{ history_q }}">

    <div class="col-auto">
      <label class="form-label">ПІБ</label>
      <input class="form-control input-name" name="full_name" maxlength="50" required>
    </div>

    <div class="col-auto">
      <label class="form-label">Дата виписки</label>
      <input class="form-control date-input" name="date_of_discharge" type="date" required>
    </div>

    <div class="col-auto">
      <label class="form-label">К днів</label>
      <input class="form-control input-xsmall" name="k_days" type="number" min="0" required>
    </div>

    <div class="col-auto" id="death-row">
      <label class="form-label">
        <input type="checkbox" id="death-checkbox" class="form-check-input me-1">
        <span style="color: #c82333;">Дата смерті</span>
      </label>
      <input id="date_of_death" class="form-control date-input" name="date_of_death" type="date" disabled>
    </div>

    <div class="col-auto">
      <label class="form-label">Історія</label>
      <input class="form-control input-history" name="history" maxlength="6" required>
    </div>

    <div class="col-auto">
      <label class="form-label">Відділення</label>
      <select class="form-select input-medium" name="discharge_department">
        <option value="">(не вказано)</option>
        {% for d in departments %}
          <option value="{{ d.name }}" {% if d.name == selected_department %}selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label">Лікар {% if physicians %}({{ physicians|length }} у списку){% endif %}</label>
      <input class="form-control input-medium" name="treating_physician" list="physicians-list" autocomplete="off" required>
      <datalist id="physicians-list">
        {% for p in physicians %}
          <option value="{{ p }}">
        {% endfor %}
      </datalist>
    </div>

    <div class="col-12">
      <label class="form-label">Коментар</label>
      <textarea class="form-control" name="comment" rows="2"></textarea>
    </div>

    <div class="col-12">
      <button class="btn btn-primary" type="submit">Додати</button>
      <a class="btn btn-secondary ms-2" href="{{ url_for('records.index') }}">Скасувати</a>
    </div>
  </form>
{% endblock %}

{% block scripts %}
<script>
  // Auto-fill yesterday's date for discharge date
  document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[name="date_of_discharge"]');
    if (dateInput && !dateInput.value) {
      // Set yesterday's date in YYYY-MM-DD format
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const year = yesterday.getFullYear();
      const month = String(yesterday.getMonth() + 1).padStart(2, '0');
      const day = String(yesterday.getDate()).padStart(2, '0');
      dateInput.value = `${year}-${month}-${day}`;
    }

    // Handle death date checkbox
    const deathCheckbox = document.getElementById('death-checkbox');
    const deathDateInput = document.getElementById('date_of_death');

    if (deathCheckbox && deathDateInput) {
      deathCheckbox.addEventListener('change', function() {
        if (this.checked) {
          deathDateInput.disabled = false;
          deathDateInput.focus();
        } else {
          deathDateInput.disabled = true;
          deathDateInput.value = '';
        }
      });

      // Clear date if checkbox is unchecked on form submit
      const form = deathDateInput.closest('form');
      if (form) {
        form.addEventListener('submit', function() {
          if (!deathCheckbox.checked) {
            deathDateInput.value = '';
          }
        });
      }
    }
  });
</script>
{% endblock %}
